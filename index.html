<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Evaluaciones – Operadores</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #d9232d;
      --primary-soft: #ffe5e7;
      --dark: #222;
      --bg: #f2f4f7;
      --card-bg: #ffffff;
      --text-main: #222;
      --text-muted: #777;
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    header {
      background: var(--dark);
      color: #fff;
      padding: 10px 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    header > div {
      max-width: 1500px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 18px;
    }

    header img { height: 55px; }

    header h1 {
      margin: 0;
      font-size: 22px;
    }

    header .subtitle {
      font-size: 13px;
      color: #ccc;
      margin-top: 3px;
    }

    .container {
      max-width: 1500px;
      margin: 15px auto 40px;
      padding: 0 10px 20px;
    }

    /* Filtros */
    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 15px;
      align-items: center;
      background: var(--card-bg);
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      margin-bottom: 18px;
      font-size: 13px;
    }
    .filters-bar input,
    .filters-bar select {
      padding: 5px 7px;
      font-size: 13px;
      border-radius: 5px;
      border: 1px solid #d0d4da;
      min-width: 140px;
    }
    .filters-bar button {
      padding: 6px 11px;
      font-size: 13px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease;
    }
    .filters-bar button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
    }
    .btn-primary   { background: var(--primary); color: #fff; }
    .btn-secondary { background: #6c757d; color: #fff; }
    .btn-pdf       { background: #d9534f; color: #fff; }

    .filters-bar .right {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }
    .kpi-card::before {
      content: "";
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 4px;
      background: var(--primary);
    }
    .kpi-title {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .kpi-value {
      font-size: 21px;
      font-weight: bold;
    }
    .kpi-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Gráficos */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 22px;
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 16px 18px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      height: 380px;
      display: flex;
      flex-direction: column;
    }

    .chart-card.wide {
      grid-column: 1 / -1;
      height: 400px;
    }

    .chart-card h3 {
      margin: 0 0 12px;
      font-size: 15px;
      font-weight: 600;
    }

    /* Tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
      font-size: 12px;
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }
    th {
      background: #f4f6f8;
      text-align: left;
    }

    tr:nth-child(even) td { background: #fafafa; }
    tr:hover td          { background: #e9f3ff; }
  </style>
</head>
<body>

<header>
  <div>
    <img src="logo_Xtreme.png" alt="Xtreme Mining">
    <div>
      <h1>Dashboard Evaluaciones – Operadores</h1>
      <div class="subtitle">
        Creado por Bernardo Ojeda Molina – Jefe de Innovación y Formación
      </div>
    </div>
  </div>
</header>

<div class="container">

  <!-- Filtros -->
  <div class="filters-bar">
    <input id="filtro-rut" placeholder="Ej: 12377087-0">
    <select id="filtro-equipo"><option value="TODOS">Todos</option></select>
    <select id="filtro-contrato"><option value="TODOS">Todos</option></select>
    <select id="filtro-instructor"><option value="TODOS">Todos</option></select>
    <button class="btn-primary" onclick="aplicarFiltros()">Buscar</button>
    <button class="btn-secondary" onclick="limpiarFiltros()">Limpiar</button>
    <button class="btn-pdf" onclick="window.print()">Exportar PDF</button>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card"><div class="kpi-title">Registros</div><div class="kpi-value" id="kpi-registros">0</div></div>
    <div class="kpi-card"><div class="kpi-title">Operadores únicos</div><div class="kpi-value" id="kpi-operadores-unicos">0</div></div>
    <div class="kpi-card"><div class="kpi-title">Promedio Nota</div><div class="kpi-value" id="kpi-prom-nota">0.0</div></div>
    <div class="kpi-card"><div class="kpi-title">Promedio Puntos</div><div class="kpi-value" id="kpi-prom-puntos">0.0</div></div>
  </div>

  <!-- Gráficos -->
  <div class="charts-grid">
    <div class="chart-card wide">
      <h3>Notas Finales por Operador</h3>
      <canvas id="chartNotaOperador"></canvas>
    </div>
    <div class="chart-card">
      <h3>Promedio Nota por Equipo</h3>
      <canvas id="chartNotaEquipo"></canvas>
    </div>
  </div>

  <!-- Tabla -->
  <table id="tabla-detalle">
    <thead>
      <tr>
        <th>RUT</th><th>Nombre</th><th>Fecha</th><th>Equipo</th>
        <th>Contrato</th><th>Instructor</th><th>Total Puntos</th><th>Nota Final</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const CSV_URLS = [
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSv2nHTgf2UJjzyxQs0e79UCLz2lRIyGO9AR4y_2p9Nq61lQ0sErMa9IakEDKy_6b4F1V2shvuu3AZQ/pub?gid=0&single=true&output=csv",
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWu_RoFhoxPb3mLa3G8OhapNtWzLoIYMtdVzTJJzBLeEyxsOYtJRmtycgL6kpsE3Pkww3OwQow8baM/pub?gid=764665870&single=true&output=csv"
];

let registrosBase = [];
let chartNotaOperador, chartNotaEquipo;

document.addEventListener("DOMContentLoaded", async () => {
  const textos = await Promise.all(CSV_URLS.map(u => fetch(u).then(r => r.text())));
  registrosBase = textos.flatMap(t => mapear(parseCSV(t)));
  poblarFiltros(registrosBase);
  aplicarFiltros();
});

function parseCSV(text){return text.trim().split("\\n").map(r=>r.split(","));}
function mapear(rows){
  const h=rows[0].map(x=>x.toUpperCase());
  const idx=n=>h.indexOf(n.toUpperCase());
  return rows.slice(1).filter(r=>r[idx("RUT")]).map(r=>({
    rut:r[idx("RUT")],nombre:r[idx("NOMBRE")],fecha:r[idx("FECHA")],
    equipo:r[idx("EQUIPO")],contrato:r[idx("CONTRATO")],instructor:r[idx("INSTRUCTOR")],
    totalPuntos:+r[idx("TOTALPUNTOS")],notaFinal:+r[idx("NOTAFINAL")]
  }));
}

function poblarFiltros(reg){
  const e=document.getElementById("filtro-equipo"),
        c=document.getElementById("filtro-contrato"),
        i=document.getElementById("filtro-instructor");
  const fill=(s,v)=>{s.innerHTML='<option value="TODOS">Todos</option>';[...new Set(v)].forEach(x=>{if(x){let o=document.createElement("option");o.value=o.textContent=x;s.appendChild(o);}})};
  fill(e,reg.map(r=>r.equipo));
  fill(c,reg.map(r=>r.contrato));
  fill(i,reg.map(r=>r.instructor));
}

function aplicarFiltros(){
  const f=document.getElementById("filtro-rut").value.toLowerCase();
  const e=document.getElementById("filtro-equipo").value;
  const c=document.getElementById("filtro-contrato").value;
  const i=document.getElementById("filtro-instructor").value;
  let d=registrosBase.filter(r=>(!f||r.rut.toLowerCase().includes(f))&&(e==="TODOS"||r.equipo===e)&&(c==="TODOS"||r.contrato===c)&&(i==="TODOS"||r.instructor===i));
  actualizarKPIs(d);dibujarTabla(d);dibujarGraficos(d);
}

function limpiarFiltros(){
  document.getElementById("filtro-rut").value="";
  ["filtro-equipo","filtro-contrato","filtro-instructor"].forEach(id=>document.getElementById(id).value="TODOS");
  aplicarFiltros();
}

function actualizarKPIs(r){
  document.getElementById("kpi-registros").textContent=r.length;
  document.getElementById("kpi-operadores-unicos").textContent=new Set(r.map(x=>x.rut)).size;
  document.getElementById("kpi-prom-nota").textContent=(r.reduce((s,x)=>s+x.notaFinal,0)/r.length||0).toFixed(1);
  document.getElementById("kpi-prom-puntos").textContent=(r.reduce((s,x)=>s+x.totalPuntos,0)/r.length||0).toFixed(1);
}

function dibujarTabla(r){
  const t=document.querySelector("#tabla-detalle tbody");
  t.innerHTML="";
  r.forEach(x=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${x.rut}</td><td>${x.nombre}</td><td>${x.fecha}</td><td>${x.equipo}</td><td>${x.contrato}</td><td>${x.instructor}</td><td>${x.totalPuntos}</td><td>${x.notaFinal}</td>`;
    t.appendChild(tr);
  });
}

function dibujarGraficos(r){
  if(chartNotaOperador)chartNotaOperador.destroy();
  if(chartNotaEquipo)chartNotaEquipo.destroy();

  const ctx1=document.getElementById("chartNotaOperador").getContext("2d");
  chartNotaOperador=new Chart(ctx1,{type:"bar",data:{labels:r.map(x=>x.nombre),datasets:[{label:"Nota Final",data:r.map(x=>x.notaFinal),backgroundColor:"#d9232d77"}]},options:{scales:{y:{beginAtZero:true,max:100}}}});

  const ctx2=document.getElementById("chartNotaEquipo").getContext("2d");
  const porEq={};
  r.forEach(x=>{if(!porEq[x.equipo])porEq[x.equipo]=[];porEq[x.equipo].push(x.notaFinal);});
  chartNotaEquipo=new Chart(ctx2,{type:"bar",data:{labels:Object.keys(porEq),datasets:[{label:"Promedio Nota",data:Object.values(porEq).map(a=>a.reduce((s,v)=>s+v,0)/a.length),backgroundColor:"#3498db77"}]},options:{scales:{y:{beginAtZero:true,max:100}}}});
}
</script>
</body>
</html>
